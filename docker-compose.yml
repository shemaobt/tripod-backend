services:
  gcp-secrets:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:alpine
    container_name: tripod_backend_gcp_secrets
    environment:
      SECRETS_PROJECT_ID: ${SECRETS_PROJECT_ID:-shemaobt-secrets}
    volumes:
      - gcp_secrets_env:/secrets
      - ${HOME}/.config/gcloud:/host-gcloud:ro
    command:
      - sh
      - -c
      - |
        cp -r /host-gcloud /tmp/gcloud
        export CLOUDSDK_CONFIG=/tmp/gcloud
        DB_URL=$$(gcloud secrets versions access latest --secret=tripod_backend_neon_database_url_local --project=$$SECRETS_PROJECT_ID | tr -d '\n')
        JWT=$$(gcloud secrets versions access latest --secret=tripod_backend_jwt_secret --project=$$SECRETS_PROJECT_ID | tr -d '\n')
        printf "DATABASE_URL='%s'\nJWT_SECRET_KEY='%s'\n" "$$DB_URL" "$$JWT" > /secrets/.env
    restart: "no"

  backend:
    build:
      context: .
      dockerfile: Dockerfile.dev
    image: tripod_backend
    container_name: tripod_backend
    ports:
      - "8000:8000"
    volumes:
      - ./:/app
      - backend_venv:/opt/venv
      - gcp_secrets_env:/run/secrets:ro
    dns:
      - 8.8.8.8
      - 8.8.4.4
    depends_on:
      gcp-secrets:
        condition: service_completed_successfully
    command: >
      sh -c "set -a && . /run/secrets/.env && set +a &&
      uv run alembic upgrade head &&
      uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"

  lint:
    build:
      context: .
      dockerfile: Dockerfile.dev
    image: tripod_backend
    container_name: tripod_backend_lint
    volumes:
      - ./:/app
      - backend_venv:/opt/venv
    command: sh -c "uv run ruff check . && uv run ruff format --check ."
    profiles:
      - lint

volumes:
  backend_venv:
  gcp_secrets_env:
